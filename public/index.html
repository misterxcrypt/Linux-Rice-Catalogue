<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rice Gallery - The Meta-Rice Experience</title>
    
    <!-- Scripts & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/colorthief@2.3.2/dist/color-thief.umd.js"></script>
    
    <style>
        :root {
            --bg-color: #0A0A0F;
            --panel-bg: rgba(22, 22, 30, 0.4);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-color: #5D5FEF;
            --accent-glow: rgba(93, 95, 239, 0.4);
            transition: --accent-color 0.5s ease, --accent-glow 0.5s ease;
        }

        @property --accent-color { syntax: '<color>'; initial-value: #5D5FEF; inherits: true; }
        @property --accent-glow { syntax: '<color>'; initial-value: rgba(93, 95, 239, 0.4); inherits: true; }

        body {
            background-color: var(--bg-color);
            color: #E0E0E0;
            font-family: 'Inter', sans-serif;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.04) 1px, transparent 0),
                radial-gradient(ellipse at 50% 0%, var(--accent-glow) 0%, transparent 45%);
            background-size: 30px 30px, 100% 100%;
            background-repeat: repeat, no-repeat;
            transition: background-position 1s ease-out;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color);
        }

        .reaction-btn.bg-white\/10 {
            border: 1px solid var(--accent-color);
        }

        .grid-masonry { column-count: 1; column-gap: 1.5rem; }
        @media (min-width: 640px) { .grid-masonry { column-count: 2; } } /* sm */
        @media (min-width: 1024px) { .grid-masonry { column-count: 3; } } /* lg */
        @media (min-width: 1536px) { .grid-masonry { column-count: 4; } } /* 2xl */
        .grid-masonry .rice-card { break-inside: avoid; margin-bottom: 1.5rem; }

        .grid-bento { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .grid-bento .rice-card:nth-child(7n+1) { grid-column: span 2; grid-row: span 2; }
        .grid-bento .rice-card:nth-child(7n+4) { grid-column: span 1; grid-row: span 2; }
        @media (max-width: 1024px) {
            .grid-bento { grid-template-columns: repeat(2, 1fr); }
            .grid-bento .rice-card { grid-column: span 1 !important; grid-row: span 1 !important; }
            .grid-bento .rice-card:nth-child(5n+1) { grid-column: span 2 !important; }
        }
         @media (max-width: 639px) { /* xs */
            .grid-bento { grid-template-columns: repeat(1, 1fr); }
            .grid-bento .rice-card { grid-column: span 1 !important; grid-row: span 1 !important; }
        }


        .grid-feed { display: flex; flex-direction: column; gap: 2rem; max-width: 800px; margin: 0 auto; }
        
        .rice-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .rice-card:hover { transform: scale(1.02); box-shadow: 0 0 25px var(--accent-glow), 0 0 0 1px var(--accent-color); z-index: 10; }

        .control-btn.active { background-color: var(--accent-color); color: white; font-weight: 600; }
        .lightbox-content, .submission-modal-content, .mood-switcher-panel { border: 1px solid var(--accent-color); box-shadow: 0 10px 50px var(--accent-glow); animation: slideUp 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        
        @keyframes slideUp { from { transform: translateY(30px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        #space-travel-overlay { background: radial-gradient(ellipse at 50% 50%, #1a2a6c, #0a0a0f); }
        .star { position: absolute; background-color: white; border-radius: 50%; animation: moveStar 10s linear infinite; }
        @keyframes moveStar { from { transform: translateY(110vh) scale(1); } to { transform: translateY(-10vh) scale(0.1); } }
        #animated-rice-card { animation: floatInSpace 5s ease-in-out forwards; }
        @keyframes floatInSpace {
            0% {
                transform: translateY(120vh) scale(0.5);
                opacity: 0;
            }
            30% {
                transform: translateY(0vh) scale(1);
                opacity: 1;
            }
            60% {
                transform: translateY(-5vh) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) scale(1.2);
                opacity: 0;
            }
        }

        .animate-floatInSpace {
        animation: floatInSpace 5s ease-in-out forwards;
        }
    </style>
</head>
<body class="min-h-screen text-gray-300">

    <!-- MAIN UI -->
    <div class="p-4 md:p-6 lg:p-8">
        <header class="mb-6 space-y-4">
             <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                 <div class="flex items-center gap-3">
                    <div class="text-3xl md:text-4xl w-10 h-10 flex items-center justify-center">🌾</div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Rice Gallery</h1>
                 </div>
                 <div class="w-full md:w-[500px] p-2 rounded-md bg-white/5 border border-[var(--border-color)] font-mono text-sm">
                    <input id="search-input" type="text" placeholder="🔍 Search rices (author, WM, distro, theme)" class="w-full p-2 rounded-md bg-white/5 border border-[var(--border-color)] font-mono text-sm" />
                 </div>
                 <div class="flex items-center gap-2">
                    <div class="view-toggle flex items-center gap-1 glass-panel p-1 rounded-lg">
                        <button title="Masonry View" data-view="masonry" class="control-btn p-2 rounded-md transition-colors hover:bg-white/10 active"><span class="material-icons-outlined">grid_view</span></button>
                        <button title="Bento View" data-view="bento" class="control-btn p-2 rounded-md transition-colors hover:bg-white/10"><span class="material-icons-outlined">dashboard</span></button>
                        <button title="Feed View" data-view="feed" class="control-btn p-2 rounded-md transition-colors hover:bg-white/10"><span class="material-icons-outlined">view_agenda</span></button>
                    </div>
                    <button id="submit-rice-btn" class="p-2.5 bg-[var(--accent-color)] text-white rounded-lg ml-2 hover:opacity-90"><span class="material-icons-outlined">add_circle</span></button>
                    <button id="login-btn" class="p-2.5 ml-2 glass-panel rounded-lg text-white font-semibold hover:bg-white/10">Login</button>
                    <button id="admin-btn" class="p-2.5 ml-2 glass-panel rounded-lg text-white font-semibold hover:bg-white/10" style="display:none">Admin</button>
                    <button id="logout-btn" class="p-2.5 ml-2 bg-[var(--accent-color)] glass-panel rounded-lg text-white font-semibold hover:bg-white/10" style="display:none">
                        <span class="material-icons-outlined text-gray-300">logout</span>
                    </button>
                 </div>
             </div>
        </header>

        <!-- Filter Controls -->
        <div id="filter-controls" class="mb-8 p-4 glass-panel rounded-xl">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <div class="font-mono text-sm uppercase text-gray-400">Filter By:</div>
                <div id="filter-type-toggle" class="flex gap-1 glass-panel p-1 rounded-lg">
                    <button data-filter-type="wm" class="control-btn px-4 py-1.5 text-sm rounded-md active">WM</button>
                    <button data-filter-type="distro" class="control-btn px-4 py-1.5 text-sm rounded-md">Distro</button>
                </div>
            </div>
            <div id="filter-pills-container" class="flex flex-wrap gap-2 justify-center">
                <!-- Filter pills injected here -->
            </div>
        </div>
        
        <div id="rice-gallery" class="grid-masonry"></div>
    </div>

    <!-- MODALS AND OVERLAYS (Same as before) -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden place-items-center p-4 bg-black/60 lightbox">

    <button id="lightbox-prev-rice"
        class="absolute left-64 top-1/2 -translate-y-1/2 text-white bg-black/60 hover:bg-black/80 p-4 rounded-full z-40 text-3xl shadow-lg transition-transform hover:scale-110">
        <span class="material-icons-outlined text-4xl">chevron_left</span>
    </button>

    <button id="lightbox-next-rice"
        class="absolute right-64 top-1/2 -translate-y-1/2 text-white bg-black/60 hover:bg-black/80 p-4 rounded-full z-40 text-3xl shadow-lg transition-transform hover:scale-110">
        <span class="material-icons-outlined text-4xl">chevron_right</span>
    </button>

    <div class="w-full max-w-6xl h-[90vh] flex flex-col md:flex-row glass-panel rounded-2xl overflow-hidden lightbox-content relative">

        <!-- Lightbox Image Viewer -->
        <div class="relative w-full md:w-2/3 lg:w-3/4 bg-black/40 flex items-center justify-center">
        <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain" crossOrigin="anonymous">
        <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-black/40 rounded-full hover:bg-black/60">
            <span class="material-icons-outlined">arrow_back</span>
        </button>
        <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-black/40 rounded-full hover:bg-black/60">
            <span class="material-icons-outlined">arrow_forward</span>
        </button>
        <div id="lightbox-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 glass-panel px-3 py-1 rounded-full text-sm font-mono"></div>
        </div>

        <!-- Details Panel -->
        <div id="lightbox-details-panel" class="w-full md:w-1/3 lg:w-1/4 p-6 flex flex-col space-y-4 overflow-y-auto">
        <div>
            <h2 id="lightbox-user" class="text-3xl font-bold text-white break-words"></h2>
            <p class="font-mono text-lg" style="color: var(--modal-accent, #fff)" id="lightbox-wm-distro-theme"></p>
        </div>
        <div class="space-y-3 font-mono text-sm border-t border-b py-4 border-[var(--border-color)]" id="lightbox-metadata"></div>
        <div class="space-y-2" id="lightbox-dotfiles"></div>
        <div class="flex-grow"></div>
        </div>

        <!-- Close Button -->
        <button id="lightbox-close" class="absolute top-3 right-3 p-2 bg-black/50 rounded-full hover:bg-black/80 z-40">
        <span class="material-icons-outlined">close</span>
        </button>
    </div>
    </div>

    <div id="submission-modal" class="fixed inset-0 z-50 hidden place-items-center p-4 bg-black/60">
        <div class="submission-modal-content glass-panel w-full max-w-4xl max-h-[90vh] rounded-2xl flex flex-col md:flex-row overflow-hidden">
            <form id="submission-form" class="w-full md:w-1/2 p-6 space-y-4 overflow-y-auto">
                <h2 class="text-2xl font-bold text-white">Submit Your Rice</h2>
                <div>
                <label class="font-mono text-sm">Reddit Post</label>
                <div class="flex items-center gap-2 mt-1">
                    <input id="reddit-post-input" type="text" placeholder="e.g., https://reddit.com" class="flex-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]">
                    <button id="scrape-reddit-btn" type="button" class="px-3 py-2 rounded-md text-sm font-mono bg-[var(--accent-color)] hover:opacity-90 transition">
                    Populate
                    </button>
                </div>
                </div>
                <div><label class="font-mono text-sm">Author*</label><input required type="text" placeholder="e.g., crunchghost" class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]"></div>
                <div><label class="font-mono text-sm">Theme</label><input type="text" placeholder="e.g., Catppuccin (Leave it if no specific theme was used)" class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]"></div>
                <!-- Dropdown to choose WM or DE -->
                <div>
                <label class="font-mono text-sm">Type*</label>
                <select id="wmde-type" required onchange="updateLabelAndPlaceholder()" class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]">
                    <option value="WM">WM (Window Manager)</option>
                    <option value="DE">DE (Desktop Environment)</option>
                </select>
                </div>

                <!-- Input field whose label/placeholder change based on selection -->
                <div>
                <label id="wmde-label" class="font-mono text-sm">Name of WM*</label>
                <input id="wmde-name" required type="text" placeholder="e.g., Hyprland" class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]">
                </div>
                <div><label class="font-mono text-sm">Distro</label><input type="text" placeholder="Arch Linux" class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]"></div>
                
                <!--
                <div id="screenshot-fields" class="space-y-2">
                <label class="font-mono text-sm block">Screenshot URLs*</label>
                <div class="screenshot">
                    <input required type="url" name="screenshot" placeholder="https://..." class="w-full p-2 rounded-md bg-white/5 border border-[var(--border-color)]" />
                </div>
                </div>
                <button type="button" onclick="addScreenshotField()" class="text-sm text-[var(--accent-color)] font-mono underline">
                + Add another screenshot
                </button>
                -->

                <div class="space-y-2" id="screenshot-upload-section">
                <label class="block text-sm font-medium text-gray-300">Upload Screenshots <span class="text-red-500">*</span></label>
                <input type="file" id="screenshot-input" accept='image/*' */ multiple class="hidden" /> 
                <button type="button" id="upload-btn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-white">📤 Select Images</button>
                <div id="screenshot-preview" class="flex flex-wrap gap-3 mt-3"></div>
                </div>

                <div><label class="font-mono text-sm">Dotfiles URL</label><input type="url" placeholder="https://github.com/..." class="w-full mt-1 p-2 rounded-md bg-white/5 border border-[var(--border-color)]"></div>
                <button type="submit" class="w-full p-3 font-bold rounded-lg text-white" style="background-color: var(--accent-color);">Launch into Orbit</button>
            </form>
            <div class="w-full md:w-1/2 p-6 bg-black/20 flex flex-col items-center justify-center">
                <p class="font-mono text-gray-400 mb-4 text-center">Live Preview</p>
                <div class="rice-card group relative rounded-xl w-full max-w-xs overflow-hidden"><img src="https://raw.githubusercontent.com/prasanthrangan/hyprdots/main/Source/assets/theme_mocha_1.png"><div class="absolute inset-0 bg-gradient-to-t from-black/80 p-4 flex flex-col justify-end"><h3 class="text-xl font-bold">Your Name</h3><p class="font-mono text-sm text-white/70">Arch + Hyprland + Theme</p></div></div>
            </div>
             <button id="submission-close-btn" class="absolute top-3 right-3 p-2 bg-black/50 rounded-full hover:bg-black/80"><span class="material-icons-outlined">close</span></button>
        </div>
    </div>
    <div id="space-travel-overlay" class="fixed inset-0 z-50 hidden overflow-hidden flex items-center justify-center px-4" style="background: radial-gradient(ellipse at 50% 50%, #1a2a6c, #0a0a0f)">
        <!-- Animated wrapper for both card and text -->
        <div id="space-travel-ship" class="flex flex-col items-center space-y-6 text-center animate-floatInSpace w-full max-w-xl">
            <div id="animated-rice-card" class="w-full p-4">
            <div class="rice-card rounded-2xl overflow-hidden border-2" style="border-color:var(--accent-color); box-shadow: 0 0 50px var(--accent-glow)">
                <img src="https://raw.githubusercontent.com/prasanthrangan/hyprdots/main/Source/assets/theme_mocha_1.png">
            </div>
            </div>
            <p class="font-mono text-lg text-white/70">Your rice has entered the galaxy.<br>Awaiting admin approval before it shines in the archive.</p>
        </div>
    </div>
    <div id="mood-switcher-container" class="fixed bottom-4 right-4 z-40">
        <div id="mood-switcher-panel" class="absolute bottom-14 right-0 grid grid-cols-4 gap-3 p-3 rounded-2xl glass-panel hidden"></div>
        <button id="mood-switcher-btn" class="w-12 h-12 rounded-full glass-panel flex items-center justify-center text-xl transition-all hover:scale-110" style="background:var(--accent-color)">🎨</button>
    </div>

    <!-- Add Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
      <div class="glass-panel rounded-2xl p-8 w-full max-w-sm mx-auto flex flex-col items-center" style="box-shadow: 0 0 50px var(--accent-glow);">
        <h2 class="text-2xl font-bold mb-4 text-white">Admin Login</h2>
        <form id="login-form" class="w-full flex flex-col gap-4">
          <input type="password" id="admin-password" placeholder="Admin Password" required class="w-full p-3 rounded-lg bg-white/5 border border-[var(--border-color)] text-white" />
          <button type="submit" class="w-full p-3 font-bold rounded-lg text-white" style="background-color: var(--accent-color);">Login</button>
        </form>
        <button id="login-close-btn" class="mt-4 text-gray-400 hover:text-white">Cancel</button>
      </div>
    </div>

    <script>
    document.getElementById('scrape-reddit-btn').addEventListener('click', async () => {
        const redditInput = document.getElementById('reddit-post-input');
        const redditUrl = redditInput.value.trim();

        if (!redditUrl || !redditUrl.includes('reddit.com')) {
            alert('❌ Please enter a valid Reddit post URL');
            return;
        }

        try {
            const res = await fetch('/api/scrapeReddit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: redditUrl })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to scrape');

            // 🧠 Populate relevant fields
            redditInput.value = data.reddit_post || redditUrl;

            document.querySelector('input[placeholder*="crunchghost"]').value = data.author || '';
            document.querySelector('input[placeholder*="Catppuccin"]').value = data.title || '';
            document.getElementById('wmde-type').value = data.environment?.type || '';
            document.getElementById('wmde-name').value = data.environment?.name || '';
            document.querySelector('input[placeholder="Arch Linux"]').value = data.distro || '';
            document.querySelector('input[placeholder^="https://github.com"]').value = data.dotfiles || '';

            // Optional: set theme if your input handles it
            if (data.theme) {
                // Insert your own input logic if you have a theme field
                const themeInput = document.querySelector('input[name="theme"]');
                if (themeInput) themeInput.value = data.theme;
            }

            // 🖼️ Screenshot preview
            /* if (Array.isArray(data.screenshots) && data.screenshots.length > 0) {
                const previewContainer = document.getElementById('screenshot-preview');
                previewContainer.innerHTML = data.screenshots
                    .map(url => `<img src="${url}" class="w-24 h-16 object-cover rounded-md" />`)
                    .join('');
                
                // 👇 Optional: if you don't want to use file upload in this case
                window.selectedFiles = []; // Reset previous file state if needed
            } */
            if (Array.isArray(data.screenshots) && data.screenshots.length > 0) {
                // Reset and store each as { url: ... }
                window.selectedFiles = data.screenshots.map(url => ({ url }));
                refreshPreview();
            }
            /* alert('✅ Populated data from Reddit!'); */
        } catch (err) {
            console.error('❌ Scrape failed:', err);
            alert('❌ Failed to fetch data from Reddit. Check the URL or try again.');
        }
    });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.querySelector('.lightbox-content');

        let isMouseInsideCard = false;

        // Mouse enter/leave tracking
        lightboxContent.addEventListener('mouseenter', () => {
            isMouseInsideCard = true;
        });

        lightboxContent.addEventListener('mouseleave', () => {
            isMouseInsideCard = false;
        });

        // Global keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('hidden')) {
            if (e.key === 'ArrowLeft') {
                if (isMouseInsideCard) {
                // Image navigation (left)
                document.getElementById('lightbox-prev')?.click();
                } else {
                // Rice navigation (left)
                document.getElementById('lightbox-prev-rice')?.click();
                }
            }

            if (e.key === 'ArrowRight') {
                if (isMouseInsideCard) {
                // Image navigation (right)
                document.getElementById('lightbox-next')?.click();
                } else {
                // Rice navigation (right)
                document.getElementById('lightbox-next-rice')?.click();
                }
            }

            if (e.key === 'Escape') {
                document.getElementById('lightbox-close')?.click();
            }

            }
        });
        });
    </script>

    <script>

    /* window.selectedFiles = [];
    const screenshotInput = document.getElementById('screenshot-input');
    const uploadBtn = document.getElementById('upload-btn');
    const previewContainer = document.getElementById('screenshot-preview');

    uploadBtn.addEventListener('click', () => {
    screenshotInput.click();
    });

    screenshotInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);

    files.forEach(file => {
        if (!file.type.startsWith('image/')) return;

        window.selectedFiles.push(file);

        const reader = new FileReader();
        reader.onload = () => {
        const imgBox = document.createElement('div');
        imgBox.className = "relative";

        imgBox.innerHTML = `
            <img src="${reader.result}" class="w-24 h-24 object-cover rounded" />
            <button type="button" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs remove-btn">&times;</button>
        `;

        imgBox.querySelector('.remove-btn').addEventListener('click', () => {
            const index = [...previewContainer.children].indexOf(imgBox);
            window.selectedFiles.splice(index, 1);
            imgBox.remove();
        });

        previewContainer.appendChild(imgBox);
        };

        reader.readAsDataURL(file);
    });

    screenshotInput.value = '';
    }); */

    window.selectedFiles = [];
    const screenshotInput = document.getElementById('screenshot-input');
    const uploadBtn = document.getElementById('upload-btn');
    const previewContainer = document.getElementById('screenshot-preview');

    uploadBtn.addEventListener('click', () => {
        screenshotInput.click();
    });

    screenshotInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            if (!file.type.startsWith('image/')) return;

            window.selectedFiles.push({ file });

            const reader = new FileReader();
            reader.onload = () => {
                addPreviewImage(reader.result, window.selectedFiles.length - 1);
            };
            reader.readAsDataURL(file);
        });

        screenshotInput.value = '';
    });

    function addPreviewImage(src, index) {
        const imgBox = document.createElement('div');
        imgBox.className = "relative";

        imgBox.innerHTML = `
            <img src="${src}" class="w-24 h-24 object-cover rounded" />
            <button type="button" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs remove-btn">&times;</button>
        `;

        imgBox.querySelector('.remove-btn').addEventListener('click', () => {
            window.selectedFiles.splice(index, 1);
            refreshPreview();
        });

        previewContainer.appendChild(imgBox);
    }

    function refreshPreview() {
        previewContainer.innerHTML = '';
        window.selectedFiles.forEach((entry, i) => {
            const src = entry.url || (entry.file ? URL.createObjectURL(entry.file) : '');
            addPreviewImage(src, i);
        });
    }

    function updateLabelAndPlaceholder() {
        const type = document.getElementById('wmde-type').value;
        const label = document.getElementById('wmde-label');
        const input = document.getElementById('wmde-name');

        if (type === 'WM') {
        label.textContent = 'Name of WM*';
        input.placeholder = 'e.g., Hyprland, i3, bspwm';
        } else {
        label.textContent = 'Name of DE*';
        input.placeholder = 'e.g., GNOME, KDE, XFCE';
        }
    }

    function getContrastTextColor([r, g, b]) {
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
        return luminance > 140 ? '#000' : '#fff';  // You can adjust the threshold
    }

    // Initialize once on page load
    updateLabelAndPlaceholder();
    </script>

    <script>
        let ricesData = [];

        async function loadRicesData() {
            try {
                const res = await fetch('/api/getRices');
                const data = await res.json();
                // Flatten wm for filtering
                ricesData = data.map(rice => ({
                    ...rice,
                    wm: (rice.environment && rice.environment.name) || ''
                }));
            } catch (e) {
                console.error('Failed to fetch rices:', e);
                ricesData = [];
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const el = {
                gallery: document.getElementById('rice-gallery'),
                filterPillsContainer: document.getElementById('filter-pills-container'),
                filterTypeToggle: document.getElementById('filter-type-toggle'),
                lightbox: document.getElementById('lightbox'),
                lightboxContent: document.getElementById('lightbox').querySelector('.lightbox-content'),
                colorThief: new ColorThief(),
                submissionModal: document.getElementById('submission-modal'),
                spaceTravelOverlay: document.getElementById('space-travel-overlay'),
                moodSwitcher: { btn: document.getElementById('mood-switcher-btn'), panel: document.getElementById('mood-switcher-panel'),},
            };

            document.getElementById('lightbox-prev-rice').addEventListener('click', (e) => {
                e.stopPropagation();
                navigateLightboxRice(-1);
            });
            document.getElementById('lightbox-next-rice').addEventListener('click', (e) => {
                e.stopPropagation();
                navigateLightboxRice(1);
            });
            
            let state = {
                viewMode: 'masonry',
                activeFilterType: 'wm', // 'wm' or 'distro'
                activeFilterValue: 'All',
                currentLightboxRice: null,
                currentImageIndex: 0,
            };
            
            const moodThemes = [ { name: 'Arc', color: '#5D5FEF', glow: 'rgba(93, 95, 239, 0.4)' }, { name: 'Pastel Pink', color: '#F48FB1', glow: 'rgba(244, 143, 177, 0.5)' }, { name: 'Terminal Green', color: '#4CAF50', glow: 'rgba(76, 175, 80, 0.4)' }, { name: 'Solarized', color: '#268BD2', glow: 'rgba(38, 139, 210, 0.4)' }, { name: 'Gruvbox', color: '#D65D0E', glow: 'rgba(214, 93, 14, 0.4)' }, { name: 'Dracula', color: '#BD93F9', glow: 'rgba(189, 147, 249, 0.4)' }, { name: 'Nord', color: '#88C0D0', glow: 'rgba(136, 192, 208, 0.4)' }, { name: 'Void', color: '#9E9E9E', glow: 'rgba(158, 158, 158, 0.3)' }, ];
            
            const render = () => {
                renderFilters();
                renderGallery();
            };

            /* const renderGallery = () => {
                let dataToRender = ricesData;
                if (state.activeFilterValue !== 'All') {
                    dataToRender = ricesData.filter(r => r[state.activeFilterType] === state.activeFilterValue);
                }
                
                el.gallery.innerHTML = '';
                el.gallery.className = `grid-${state.viewMode}`;
                dataToRender.forEach((rice) => el.gallery.appendChild(createRiceCard(rice, ricesData.indexOf(rice))));
                initScrollObserver();
            }; */
            const renderGallery = () => {
                const query = document.getElementById('search-input')?.value.toLowerCase() || "";
                let dataToRender = ricesData;

                if (state.activeFilterValue !== 'All') {
                    dataToRender = dataToRender.filter(r => r[state.activeFilterType] === state.activeFilterValue);
                }

                if (query) {
                    dataToRender = dataToRender.filter(r => {
                        const values = [
                            r.author || '',
                            r.wm || '',
                            r.distro || '',
                            r.theme || ''
                        ].join(' ').toLowerCase();
                        return values.includes(query);
                    });
                }

                el.gallery.innerHTML = '';
                el.gallery.className = `grid-${state.viewMode}`;
                dataToRender.forEach((rice) => el.gallery.appendChild(createRiceCard(rice, ricesData.indexOf(rice))));
                initScrollObserver();
            };

            document.getElementById('search-input').addEventListener('input', renderGallery);
            
            const renderFilters = () => {
                const filterKey = state.activeFilterType;
                const uniqueValues = ['All', ...new Set(ricesData.map(r => r[filterKey]).sort())];
                
                el.filterPillsContainer.innerHTML = uniqueValues.map(value => 
                    `<button data-filter-value="${value}" class="control-btn px-3 py-1.5 rounded-lg text-sm transition-colors hover:bg-white/10 ${value === state.activeFilterValue ? 'active' : ''}">${value}</button>`
                ).join('');

                el.filterPillsContainer.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        state.activeFilterValue = btn.dataset.filterValue;
                        render();
                    });
                });
            };
            
            const createRiceCard = (rice, originalIndex) => {
                // Map DB fields to expected frontend fields
                const user = rice.author || '';
                const wm = (rice.environment && rice.environment.name) || '';
                const distro = rice.distro || '';
                const theme = rice.theme || '';
                const url = rice.dotfiles || '';
                let images = rice.images || [];
                if (typeof images === 'string') images = [images];
                const reactions = rice.reactions || { heart: 0, fire: 0, down: 0 };
                const card = document.createElement('div');
                card.className = `rice-card group relative rounded-2xl overflow-hidden cursor-pointer flex bg-[#111116] border border-[var(--border-color)]`;
                card.dataset.index = originalIndex;
                /* Commented the rection section */
                card.innerHTML = `
                    <div class="card-image w-full h-full">
                        <img src="${images[0] || ''}" alt="${user}'s ${wm} rice" loading="lazy" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 p-4 flex flex-col justify-end">
                        <h3 class="text-xl font-bold text-white">${user}</h3>
                        <div class="flex justify-between items-center text-sm text-white/70">
                            <p class="font-mono truncate">${distro} + ${wm}</p>
                            <!-- <div class="flex gap-2 text-white/80 ml-4 shrink-0">
                                <span title="Love">❤️ ${reactions.heart || 0}</span>
                                <span title="Fire">🔥 ${reactions.fire || 0}</span>
                                <span title="Downvote">⬇️ ${reactions.down || 0}</span>
                            </div> -->
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => showLightbox(originalIndex));
                return card;
            };

            const initScrollObserver = () => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const rice = ricesData[parseInt(entry.target.dataset.index)];
                            const themeName = rice.theme || 'Arc'; // Fallback to Arc if no theme
                            const theme = moodThemes.find(t => t.name.toLowerCase() === themeName.toLowerCase()) || moodThemes.find(t => t.name === 'Arc');
                            document.documentElement.style.setProperty('--accent-color', theme.color);
                            document.documentElement.style.setProperty('--accent-glow', theme.glow);
                        }
                    });
                }, { rootMargin: '-40% 0px -40% 0px' });
                el.gallery.querySelectorAll('.rice-card').forEach(card => observer.observe(card));
            };
            
            const handleViewToggle = (e) => {
                const btn = e.target.closest('button');
                if (btn) {
                    state.viewMode = btn.dataset.view;
                    document.querySelector('.view-toggle .active').classList.remove('active');
                    btn.classList.add('active');
                    renderGallery();
                }
            };

            el.filterTypeToggle.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && !btn.classList.contains('active')) {
                    el.filterTypeToggle.querySelector('.active').classList.remove('active');
                    btn.classList.add('active');
                    state.activeFilterType = btn.dataset.filterType;
                    state.activeFilterValue = 'All'; // Reset filter value when type changes
                    render();
                }
            });
            
            // LIGHTBOX (Logic remains largely the same)
            const showLightbox = async (index) => {
                state.currentLightboxRiceIndex = index;
                // Map DB fields to expected frontend fields for lightbox
                const rice = ricesData[index];
                let images = rice.images || [];
                if (typeof images === 'string') images = [images];
                state.currentLightboxRice = {
                    user: rice.author || '',
                    wm: (rice.environment && rice.environment.name) || '',
                    distro: rice.distro || '',
                    theme: rice.theme || '',
                    url: rice.dotfiles || '',
                    images,
                };
                state.currentImageIndex = 0;
                const imgEl = el.lightbox.querySelector('#lightbox-image');
                imgEl.src = state.currentLightboxRice.images[0] || '';
                await new Promise(resolve => { imgEl.onload = resolve; imgEl.onerror = resolve; });
                try {
                    if (imgEl.complete && imgEl.naturalHeight !== 0) {
                        const dominantColor = el.colorThief.getColor(imgEl);
                        const textColor = getContrastTextColor(dominantColor);
                        card.querySelector('h3').style.color = textColor;
                        card.querySelector('p').style.color = textColor;
                        const rgb = `rgb(${dominantColor.join(',')})`;
                        const isDark = (dominantColor[0] * 0.299 + dominantColor[1] * 0.587 + dominantColor[2] * 0.114) < 128;
                        el.lightboxContent.style.setProperty('--modal-accent', rgb);
                        el.lightbox.querySelector('#lightbox-details-panel').style.setProperty('--modal-text', isDark ? '#fff' : '#000');
                    } else {
                        el.lightboxContent.style.setProperty('--modal-accent', 'var(--accent-color)');
                        el.lightbox.querySelector('#lightbox-details-panel').style.setProperty('--modal-text', '#fff');
                    }
                } catch(e) {
                    el.lightboxContent.style.setProperty('--modal-accent', 'var(--accent-color)');
                    el.lightbox.querySelector('#lightbox-details-panel').style.setProperty('--modal-text', '#fff');
                }
                updateLightboxContent();
                el.lightbox.querySelectorAll('.reaction-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // Prevent lightbox from closing
                        const button = e.currentTarget;
                        const reaction = button.dataset.reaction;
                        const id = button.dataset.id;

                        // Save user's choice in localStorage
                        localStorage.setItem(`reaction_${id}`, reaction);

                        // Send to server
                        try {
                            const res = await fetch('/api/reactRice', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ _id: id, reaction })
                            });
                            if (!res.ok) throw new Error("Failed to send reaction");
                            // Optionally, update UI or re-fetch rice data
                        } catch (err) {
                            console.error('Reaction error:', err);
                        }
                    });
                });
                el.lightbox.classList.replace('hidden', 'grid');
            };
            const hideLightbox = () => el.lightbox.classList.replace('grid', 'hidden');
            function navigateLightboxRice(dir) {
                let index = parseInt(state.currentLightboxRiceIndex || 0);
                const total = ricesData.length;
                index = (index + dir + total) % total; // wrap around
                showLightbox(index);
            }
            const changeLightboxImage = (dir) => {
                state.currentImageIndex = (state.currentImageIndex + dir + state.currentLightboxRice.images.length) % state.currentLightboxRice.images.length;
                updateLightboxContent();
            };
            const updateLightboxContent = () => {
                const rice = state.currentLightboxRice;
                const setContent = (id, text) => el.lightbox.querySelector(id).textContent = text;
                setContent('#lightbox-user', rice.user);
                setContent('#lightbox-wm-distro-theme', `${rice.wm || 'Unknown'} / ${rice.distro || 'Unknown'} / ${rice.theme || 'Unknown'}`);
                el.lightbox.querySelector('#lightbox-metadata').innerHTML = `<div class="flex items-center gap-3"><span class="material-icons-outlined text-lg w-5 text-center" style="color:var(--modal-accent)">desktop_windows</span>${rice.wm || 'Unknown'}</div><div class="flex items-center gap-3"><span class="material-icons-outlined text-lg w-5" style="color:var(--modal-accent)">dns</span>${rice.distro || 'Unknown'}</div><div class="flex items-center gap-3"><span class="material-icons-outlined text-lg w-5" style="color:var(--modal-accent)">palette</span>${rice.theme || 'Unknown'}</div>`;
                const dotfilesHTML = rice.url
                    ? `<h3 class="font-mono text-sm uppercase text-gray-400">Dotfiles</h3>
                        <div class="grid grid-cols-1 gap-2">
                        <a href="${rice.url}" target="_blank" class="flex items-center justify-center gap-2 p-2 rounded-lg text-sm font-semibold" style="background:var(--modal-accent); color: var(--modal-text)">View</a>
                        </div>`
                    : `<h3 class="font-mono text-sm uppercase text-gray-400">Dotfiles</h3>
                        <p class="text-white/60 text-sm italic">No dotfiles provided for this rice.</p>`;
                el.lightbox.querySelector('#lightbox-dotfiles').innerHTML = dotfilesHTML;            
                const reactions = [
                    { key: 'heart', emoji: '❤️' },
                    { key: 'fire', emoji: '🔥' },
                    { key: 'down', emoji: '⬇️' }
                ];
                /* Get current reaction from localStorage */
                const userReactionKey = `reaction_${rice._id}`;
                const currentUserReaction = localStorage.getItem(userReactionKey);

                /* el.lightbox.querySelector('#lightbox-reactions').innerHTML = reactions
                .map(r => {
                    const count = rice.reactions?.[r.key] || 0;
                    const isActive = r.key === currentUserReaction;
                    return `<button 
                    class="reaction-btn px-3 py-1 glass-panel rounded-full text-lg hover:bg-white/10 ${isActive ? 'bg-white/10' : ''}"
                    data-reaction="${r.key}"
                    data-id="${rice._id}"
                    >${r.emoji} ${count}</button>`;
                })
                .join(''); */
                el.lightbox.querySelector('#lightbox-image').src = rice.images[state.currentImageIndex] || '';
                setContent('#lightbox-counter', `${state.currentImageIndex + 1} / ${rice.images.length}`);
            };
            
            // SUBMISSION & ANIMATION (Logic remains the same)
            const showSubmissionModal = () => el.submissionModal.classList.replace('hidden', 'grid');
            const hideSubmissionModal = () => el.submissionModal.classList.replace('grid', 'hidden');
            const handleSubmission = (e) => {
                e.preventDefault();
                hideSubmissionModal();
                el.spaceTravelOverlay.querySelector('.star-container')?.remove();
                const starContainer = document.createElement('div');
                starContainer.className = 'star-container absolute inset-0';
                for (let i = 0; i < 50; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    const size = Math.random() * 2 + 1;
                    star.style.cssText = `width:${size}px; height:${size}px; left:${Math.random()*100}%; top: ${Math.random()* -50}vh; animation-delay: ${Math.random()*10}s; animation-duration: ${Math.random()*5+5}s`;
                    starContainer.appendChild(star);
                }

                const ship = document.getElementById('space-travel-ship');
                ship.classList.remove('animate-floatInSpace');
                void ship.offsetWidth; // trigger reflow
                ship.classList.add('animate-floatInSpace');
                
                el.spaceTravelOverlay.prepend(starContainer);
                el.spaceTravelOverlay.classList.remove('hidden');
                setTimeout(() => el.spaceTravelOverlay.classList.add('hidden'), 5000);
            };

            // MOOD SWITCHER (Logic remains the same)
            const applyTheme = (theme) => {
                document.documentElement.style.setProperty('--accent-color', theme.color);
                document.documentElement.style.setProperty('--accent-glow', theme.glow);
                el.moodSwitcher.btn.style.background = `linear-gradient(45deg, ${theme.color}, ${theme.glow})`;
                localStorage.setItem('rice-gallery-theme', theme.name);
            };
            const initMoodSwitcher = () => {
                moodThemes.forEach(theme => {
                    const btn = document.createElement('button');
                    btn.className = 'w-10 h-10 rounded-full transition-transform hover:scale-110';
                    btn.style.background = `linear-gradient(45deg, ${theme.color}, ${theme.glow})`;
                    btn.title = theme.name;
                    btn.addEventListener('click', () => applyTheme(theme));
                    el.moodSwitcher.panel.appendChild(btn);
                });
                const savedTheme = localStorage.getItem('rice-gallery-theme');
                if (savedTheme) applyTheme(moodThemes.find(t => t.name === savedTheme) || moodThemes[0]);
                el.moodSwitcher.btn.addEventListener('click', () => el.moodSwitcher.panel.classList.toggle('hidden'));
            };

            // ATTACH LISTENERS
            document.querySelector('.view-toggle').addEventListener('click', handleViewToggle);
            el.lightbox.querySelector('#lightbox-close').addEventListener('click', hideLightbox);
            el.lightbox.addEventListener('click', (e) => {
                if (!el.lightboxContent.contains(e.target)) {
                    hideLightbox();
                }
            });
            el.lightbox.querySelector('#lightbox-prev').addEventListener('click', () => changeLightboxImage(-1));
            el.lightbox.querySelector('#lightbox-next').addEventListener('click', () => changeLightboxImage(1));
            document.getElementById('submit-rice-btn').addEventListener('click', showSubmissionModal);
            document.getElementById('submission-close-btn').addEventListener('click', hideSubmissionModal);
            document.getElementById('submission-form').addEventListener('submit', handleSubmission);

            // --- Admin Login Logic ---
            function showLoginModal() {
              document.getElementById('login-modal').classList.replace('hidden', 'flex');
            }
            function hideLoginModal() {
              document.getElementById('login-modal').classList.replace('flex', 'hidden');
            }
            function showLogoutBtn() {
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('admin-btn').style.display = '';
                document.getElementById('logout-btn').style.display = '';
            }
            function showLoginBtn() {
                document.getElementById('login-btn').style.display = '';
                document.getElementById('admin-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
            }
            async function handleLogin(e) {
              e.preventDefault();
              const password = document.getElementById('admin-password').value;
              const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
              });
              if (res.ok) {
                const { token } = await res.json();
                localStorage.setItem('adminToken', token);
                window.location.href = '/admin.html';
              } else {
                alert('Login failed');
              }
            }
            function handleLogout() {
              localStorage.removeItem('adminToken');
              showLoginBtn();
            }
            function handleAdmin() {
                window.location.href = '/admin.html';
            }   
            function checkLogin() {
              const token = localStorage.getItem('adminToken');
              if (token) showLogoutBtn();
              else showLoginBtn();
            }
            document.getElementById('login-btn').addEventListener('click', showLoginModal);
            document.getElementById('login-close-btn').addEventListener('click', hideLoginModal);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('admin-btn').addEventListener('click', handleAdmin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            checkLogin();

            // INITIALIZE
            await loadRicesData();
            initMoodSwitcher();
            render(); // Initial render
        });
    </script>
    <script>
    function addScreenshotField() {
        const container = document.getElementById('screenshot-fields');
        const newField = document.createElement('div');
        /* newField.classList.add('screenshot'); */
        newField.classList.add('relative', 'w-full');

        newField.innerHTML = `
            <input required type="url" name="screenshot"
                placeholder="https://..." 
                class="w-full p-2 pr-8 rounded-md bg-white/5 border border-[var(--border-color)]" />
                <button type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-white/70 hover:text-red-500"
                title="Remove screenshot">✕</button>
        `;
        // Add event listener for remove button
        newField.querySelector('button').addEventListener('click', () => {
            newField.remove();
        });
        container.appendChild(newField);
    }

    function updateLabelAndPlaceholder() {
        const type = document.getElementById('wmde-type').value;
        const label = document.getElementById('wmde-label');
        const input = document.getElementById('wmde-name');

        if (type === 'WM') {
        label.textContent = 'Name of WM*';
        input.placeholder = 'e.g., Hyprland, i3, bspwm';
        } else {
        label.textContent = 'Name of DE*';
        input.placeholder = 'e.g., GNOME, KDE, XFCE';
        }
    }

    // Auto-set on load
    updateLabelAndPlaceholder();

    // --- Submit Handler ---
    document.getElementById('submission-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const reddit_post = form.querySelector('input[placeholder*="https://reddit.com"]').value;
        const author = form.querySelector('input[placeholder*="crunchghost"]').value;
        const theme = form.querySelector('input[placeholder*="Catppuccin"]').value;
        const type = document.getElementById('wmde-type').value;
        const wmName = document.getElementById('wmde-name').value;
        const distro = form.querySelector('input[placeholder="Arch Linux"]').value;
        /* const images = Array.from(form.querySelectorAll('input[name="screenshot"]'))
            .map(input => input.value.trim())
            .filter(url => url !== ""); */
        const images = window.selectedFiles || [];
        const dotfiles = form.querySelector('input[placeholder^="https://github.com"]').value;

        /* const riceData = {
        author,
        title,
        distro,
        dotfiles,
        images,
        reddit_post,
        environment: {
            type: type,
            name: wmName
        }
        }; */

        const formData = new FormData();
        formData.append('author', author);
        formData.append('theme', theme);
        formData.append('distro', distro);
        formData.append('dotfiles', dotfiles);
        formData.append('reddit_post', reddit_post);
        formData.append('type', type);
        formData.append('wmName', wmName);

        /* if (images.every(img => img.file)) {
        // All are File uploads */
        images.forEach(img => {
            if (img.file) {
                formData.append('screenshots', img.file);  // key for files
            } else if (img.url) {
                formData.append('urls', img.url);  // key for URLs (repeating)
            }
        });
        /* } else if (images.every(img => img.url)) {
        // All are image URLs (e.g. Reddit scrape)
        formData.append('images', JSON.stringify(images.map(img => img.url)));
        } else { */
        /* alert('❌ Mixed file and URL uploads are not supported together. Please choose one method.'); */
        /* return;
        } */

        try {
            /* const res = await fetch('/api/submitRice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(riceData)
            }); */

            /* console.log(formData) */

            const res = await fetch('/api/submitRice', {
                method: 'POST',
                body: formData
            });

            let result;
            const contentType = res.headers.get('content-type') || '';

            if (contentType.includes('application/json')) {
                result = await res.json();
            } else {
                const text = await res.text();
                throw new Error('Non-JSON response: ' + text);
            }

            if (res.ok) {
                /* alert('🚀 Rice submitted successfully! Awaiting approval.'); */
                form.reset();
                updateLabelAndPlaceholder(); // Reset label after form clears
                window.selectedFiles = [];
                document.getElementById('screenshot-preview').innerHTML = '';
            } else {
                throw new Error(result.error || 'Failed to submit');
            }
        } catch (err) {
        console.error('❌ Submission error:', err);
        alert('❌ Submission failed. Check console for details.');
        }
    });
    </script>
</body>
</html>