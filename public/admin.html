<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rice Gallery Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0A0A0F;
            --panel-bg: rgba(22, 22, 30, 0.4);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-color: #5D5FEF;
            --accent-glow: rgba(93, 95, 239, 0.4);
            transition: --accent-color 0.5s ease, --accent-glow 0.5s ease;
        }
        body {
            background-color: var(--bg-color);
            color: #E0E0E0;
            font-family: 'Inter', sans-serif;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.04) 1px, transparent 0),
                radial-gradient(ellipse at 50% 0%, var(--accent-glow) 0%, transparent 45%);
            background-size: 30px 30px, 100% 100%;
            background-repeat: repeat, no-repeat;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color);
        }
        .tab-btn.active {
            background: var(--accent-color);
            color: #fff;
        }
    </style>
</head>
<body class="min-h-screen text-gray-300">
    <div class="p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
            <!--  <img src="https://raw.githubusercontent.com/zemmsoares/awesome-rices/main/assets/logo.webp" alt="Awesome Rices logo" class="w-10 h-10"> -->
              <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Admin Dashboard</h1>
            </div>
          
            <div class="flex items-center gap-3">
              <a href="/" class="glass-panel px-4 py-2 rounded-lg text-white font-semibold hover:bg-white/10">
                Back to Gallery
              </a>
              <button
                id="logout-btn"
                title="Logout"
                class="glass-panel bg-[var(--accent-color)] px-4 py-2 rounded-lg text-white font-semibold hover:bg-white/10"
              >
                <span class="material-icons-outlined text-lg text-gray-300">logout</span>
              </button>
            </div>
        </header>          
        <div class="mb-8 flex gap-4">
            <button id="tab-submissions" class="tab-btn px-6 py-2 rounded-lg font-semibold active">Submissions</button>
            <button id="tab-stats" class="tab-btn px-6 py-2 rounded-lg font-semibold">Stats</button>
        </div>
        <!-- Submissions Section -->
        <section id="submissions-section" class="glass-panel rounded-xl p-6">
            <h2 class="text-2xl font-bold mb-4">Pending Submissions</h2>
            <div id="pending-list" class="space-y-4">
                <!-- Pending rices will be listed here -->
                <div class="text-gray-400">No pending submissions (placeholder)</div>
            </div>
        </section>
        <!-- Stats Section -->
        <section id="stats-section" class="glass-panel rounded-xl p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Stats</h2>
            <div class="flex flex-col md:flex-row gap-8 items-start">
                <div class="space-y-2">
                    <div>Total Rices: <span id="stat-total" class="font-bold">0</span></div>
                    <div>Unique WMs: <span id="stat-wms" class="font-bold">0</span></div>
                    <div>Unique Themes: <span id="stat-themes" class="font-bold">0</span></div>
                </div>
                <div class="flex-1">
                    <div class="flex justify-end items-center mb-4">
                      <button id="toggle-chart-type" class="text-sm px-4 py-2 font-mono rounded border border-[var(--border-color)] hover:bg-white/10">
                        üéõÔ∏è View: WM
                      </button>
                    </div>
                  
                    <!-- üëá Add max-w and aspect control to the canvas wrapper -->
                    <div class="w-full max-w-md mx-auto">
                      <canvas id="stats-pie" width="500" height="500"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div id="delete-dialog" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
      <div class="glass-panel rounded-2xl p-8 w-full max-w-sm mx-auto flex flex-col items-center" style="box-shadow: 0 0 50px var(--accent-glow);">
        <h2 class="text-2xl font-bold mb-4 text-white">Delete Image</h2>
        <p class="text-gray-300 mb-6 text-center">Are you sure you want to delete this image? This action cannot be undone.</p>
        <div class="flex gap-4">
          <button id="delete-confirm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
          <button id="delete-cancel" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
        </div>
      </div>
    </div>

    <script>
        // document.getElementById('toggle-chart-type').addEventListener('click', () => {
        //     currentChartType = currentChartType === 'wms' ? 'themes' : 'wms';
        //     renderStats(window.latestStats); // assumes you cache the stats
        // });
        // Tab switching logic
        const tabSubmissions = document.getElementById('tab-submissions');
        const tabStats = document.getElementById('tab-stats');
        const submissionsSection = document.getElementById('submissions-section');
        const statsSection = document.getElementById('stats-section');
        tabSubmissions.addEventListener('click', () => {
            tabSubmissions.classList.add('active');
            tabStats.classList.remove('active');
            submissionsSection.classList.remove('hidden');
            statsSection.classList.add('hidden');
        });
        tabStats.addEventListener('click', () => {
            tabStats.classList.add('active');
            tabSubmissions.classList.remove('active');
            statsSection.classList.remove('hidden');
            submissionsSection.classList.add('hidden');
        });

        // --- Admin API Integration ---
        const token = localStorage.getItem('adminToken');
        if (!token) {
            alert('Not authorized. Please login.');
            window.location.href = '/';
        }
        // ‚úÖ Function to send status updates to backend
        async function updateRiceStatus(id, status) {
            try {
            const res = await fetch('/api/updateStatus', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id, status })
            });

            const result = await res.json();

            if (!res.ok) {
                throw new Error(result.error || 'Failed to update status');
            }

            return result;
            } catch (error) {
            console.error(`‚ùå Error updating status for ${id}:`, error);
            alert(`‚ùå Failed to update status: ${error.message}`);
            }
        }
        // Function to update rice details
        async function updateRiceDetails(id, data) {
            try {
            const res = await fetch('/api/updateRice', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'Authorization': token
                },
                body: JSON.stringify({ _id: id, ...data })
            });
            const result = await res.json();
            if (!res.ok) {
                throw new Error(result.error || 'Failed to update rice');
            }
            return result;
            } catch (error) {
            console.error(`‚ùå Error updating rice ${id}:`, error);
            alert(`‚ùå Failed to update rice: ${error.message}`);
            }
        }
        // Function to delete image from ImageKit
        async function deleteImage(url) {
            try {
            const res = await fetch('/api/deleteImage', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'Authorization': token
                },
                body: JSON.stringify({ url })
            });
            const result = await res.json();
            if (!res.ok) {
                throw new Error(result.error || 'Failed to delete image');
            }
            return result;
            } catch (error) {
            console.error(`‚ùå Error deleting image ${url}:`, error);
            alert(`‚ùå Failed to delete image: ${error.message}`);
            }
        }
        // Fetch and render pending rices
        async function fetchPendingRices() {
            const res = await fetch('/api/getPendingRices', {
                headers: { 'Authorization': token }
            });
            if (res.status === 401) {
                alert('Session expired. Please login again.');
                localStorage.removeItem('adminToken');
                window.location.href = '/';
                return;
            }
            const rices = await res.json();
            renderPendingRices(rices);
        }
        // HTML templates
        const viewHTML = (rice) => `
            <div class="flex-1">
            <div class="font-bold text-lg text-white">${rice.author || ''}</div>
            <div class="font-mono text-sm text-gray-400">
                ${(rice.environment && rice.environment.name) || ''}
                ${rice.distro ? '¬∑ ' + rice.distro : ''}
            </div>
            ${rice.dotfiles ? `
                <div class="mt-2">
                    <a href="${rice.dotfiles}" target="_blank" class="text-blue-400 underline">Dotfiles</a>
                </div>` : ''}
            ${rice.reddit_post ? `
                <div class="mt-1">
                    <a href="${rice.reddit_post}" target="_blank" class="text-orange-400 underline">Reddit Post</a>
                </div>` : ''}
            <div class="flex gap-2 mt-2">
                ${(rice.images || []).slice(0, 2).map(image =>
                    `<img src="${image.url}" class="w-20 h-12 object-cover rounded-md" />`).join('')}
            </div>
            </div>
            <div class="flex gap-2">
                <button class="edit-btn px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700" data-id="${rice._id}">Edit</button>
                <button class="approve-btn px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700" data-id="${rice._id}">Approve</button>
                <button class="reject-btn px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700" data-id="${rice._id}">Reject</button>
            </div>
        `;
        const editHTML = (rice) => `
            <div class="flex-1">
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Author</label>
                <input type="text" value="${rice.author || ''}" class="author-input w-full p-2 rounded bg-gray-700 text-white" />
            </div>
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Environment</label>
                <input type="text" value="${rice.environment && rice.environment.name || ''}" class="env-input w-full p-2 rounded bg-gray-700 text-white" />
            </div>
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Distro</label>
                <input type="text" value="${rice.distro || ''}" class="distro-input w-full p-2 rounded bg-gray-700 text-white" />
            </div>
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Dotfiles</label>
                <input type="url" value="${rice.dotfiles || ''}" class="dotfiles-input w-full p-2 rounded bg-gray-700 text-white" />
            </div>
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Reddit Post</label>
                <input type="url" value="${rice.reddit_post || ''}" class="reddit-input w-full p-2 rounded bg-gray-700 text-white" />
            </div>
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-300">Images</label>
                <div class="flex gap-2 mt-2 images-container">
                    ${(rice.images || []).map((url, index) => `
                        <div class="relative">
                            <img src="${url}" class="w-20 h-12 object-cover rounded-md" />
                            <button class="delete-image-btn absolute top-0 right-0 bg-red-600 text-white rounded-full w-4 h-4 text-xs" data-index="${index}" data-url="${url}">√ó</button>
                        </div>
                    `).join('')}
                </div>
            </div>
            </div>
            <div class="flex gap-2">
                <button class="save-btn px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700" data-id="${rice._id}">Save</button>
                <button class="cancel-btn px-4 py-2 rounded-lg bg-gray-600 text-white font-semibold hover:bg-gray-700" data-id="${rice._id}">Cancel</button>
            </div>
        `;
        function attachViewHandlers(div, rice) {
            const editBtn = div.querySelector('.edit-btn');
            const approveBtn = div.querySelector('.approve-btn');
            const rejectBtn = div.querySelector('.reject-btn');
            editBtn.addEventListener('click', () => {
                div.innerHTML = editHTML(rice);
                attachEditHandlers(div, rice);
            });
            approveBtn.addEventListener('click', async () => {
                approveBtn.disabled = true;
                approveBtn.textContent = 'Approving...';
                await updateRiceStatus(approveBtn.dataset.id, 'approved');
                fetchPendingRices();
            });
            rejectBtn.addEventListener('click', async () => {
                rejectBtn.disabled = true;
                rejectBtn.textContent = 'Rejecting...';
                await updateRiceStatus(rejectBtn.dataset.id, 'rejected');
                fetchPendingRices();
            });
        }
        function attachEditHandlers(div, rice) {
            let currentImages = [...(rice.images || [])];
            const saveBtn = div.querySelector('.save-btn');
            const cancelBtn = div.querySelector('.cancel-btn');
            saveBtn.addEventListener('click', async () => {
                const author = div.querySelector('.author-input').value;
                const env = div.querySelector('.env-input').value;
                const distro = div.querySelector('.distro-input').value;
                const dotfiles = div.querySelector('.dotfiles-input').value;
                const reddit = div.querySelector('.reddit-input').value;
                const data = {
                    author,
                    environment: { type: rice.environment.type, name: env },
                    distro,
                    dotfiles,
                    reddit_post: reddit,
                    images: currentImages.map(image => {
                        const filename = image.url.split('/').pop();
                        return [filename, image.fileId];
                    })
                };
                await updateRiceDetails(rice._id, data);
                // Refresh the entire list with updated data from DB
                fetchPendingRices();
            });
            cancelBtn.addEventListener('click', () => {
                div.innerHTML = viewHTML(rice);
                attachViewHandlers(div, rice);
            });
            // Image deletion handlers
            function updateImagesContainer(images) {
                const container = div.querySelector('.images-container');
                container.innerHTML = images.map((image, index) => `
                    <div class="relative">
                        <img src="${image.url}" class="w-20 h-12 object-cover rounded-md" />
                        ${image.fileId ? `<button class="delete-image-btn absolute top-0 right-0 bg-red-600 text-white rounded-full w-4 h-4 text-xs" data-index="${index}" data-url="${image.fileId}">√ó</button>` : ''}
                    </div>
                `).join('');
                // Re-attach delete handlers
                div.querySelectorAll('.delete-image-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        const url = btn.dataset.url;
                        pendingDelete = { index, url, currentImages, updateImagesContainer };
                        deleteDialog.classList.replace('hidden', 'flex');
                    });
                });
            }
            updateImagesContainer(currentImages); // initial attach
        }
        function renderPendingRices(rices) {
            const list = document.getElementById('pending-list');
            if (!rices.length) {
                list.innerHTML = '<div class="text-gray-400">No pending submissions.</div>';
                return;
            }
            list.innerHTML = '';
            rices.forEach(rice => {
                const div = document.createElement('div');
                div.className = 'glass-panel p-4 rounded-lg flex flex-col md:flex-row md:items-center gap-4';
                div.innerHTML = viewHTML(rice);
                list.appendChild(div);
                div.rice = rice;
                attachViewHandlers(div, rice);
            });
        }

        // async function updateRiceStatus(id, status) {
        //     await fetch('/api/updateRice', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'Authorization': token
        //         },
        //         body: JSON.stringify({ _id: id, status })
        //     });
        // }

        // Fetch and render stats
        // async function fetchStats() {
        //     const res = await fetch('/api/stats', {
        //         headers: { 'Authorization': token }
        //     });
        //     if (res.status === 401) {
        //         alert('Session expired. Please login again.');
        //         localStorage.removeItem('adminToken');
        //         window.location.href = '/';
        //         return;
        //     }
        //     const stats = await res.json();
        //     renderStats(stats);
        // }
        // function renderStats(stats) {
        //     document.getElementById('stat-total').textContent = stats.total;
        //     document.getElementById('stat-wms').textContent = Object.keys(stats.wms).length;
        //     document.getElementById('stat-themes').textContent = Object.keys(stats.themes).length;
        //     // Pie chart for WMs
        //     const ctx = document.getElementById('stats-pie').getContext('2d');
        //     if (window.statsPieChart) window.statsPieChart.destroy();
        //     window.statsPieChart = new Chart(ctx, {
        //         type: 'pie',
        //         data: {
        //             labels: Object.keys(stats.wms),
        //             datasets: [{
        //                 data: Object.values(stats.wms),
        //                 backgroundColor: [
        //                     '#5D5FEF', '#F48FB1', '#4CAF50', '#268BD2', '#D65D0E', '#BD93F9', '#88C0D0', '#9E9E9E', '#FFD700', '#FF6347'
        //                 ]
        //             }]
        //         },
        //         options: {
        //             plugins: {
        //                 legend: { labels: { color: '#fff', font: { family: 'Inter' } } }
        //             }
        //         }
        //     });
        // }
        document.addEventListener('DOMContentLoaded', () => {
        let currentChartType = 'wms'; // 'wms' or 'themes'
        const token = localStorage.getItem('adminToken');
        window.latestStats = null;

        // Attach toggle button click
        const toggleBtn = document.getElementById('toggle-chart-type');
        toggleBtn.addEventListener('click', () => {
            console.log('‚úÖ Toggle clicked. Current type:', currentChartType);
            currentChartType = currentChartType === 'wms' ? 'themes' : 'wms';
            renderStats(window.latestStats);
        });

        // Fetch stats from backend
        async function fetchStats() {
            const res = await fetch('/api/stats', {
            headers: { 'Authorization': token }
            });
            if (res.status === 401) {
            alert('Session expired. Please login again.');
            localStorage.removeItem('adminToken');
            window.location.href = '/';
            return;
            }
            const stats = await res.json();
            window.latestStats = stats;
            renderStats(stats);
        }

        // Render pie chart
        function renderStats(stats) {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-wms').textContent = Object.keys(stats.wms).length;
            document.getElementById('stat-themes').textContent = Object.keys(stats.themes).length;

            const ctx = document.getElementById('stats-pie').getContext('2d');
            if (window.statsPieChart) window.statsPieChart.destroy();

            const dataSource = currentChartType === 'wms' ? stats.wms : stats.themes;

            // Update button label
            toggleBtn.textContent = currentChartType === 'wms' ? 'üéõÔ∏è View: WM' : 'üé® View: Themes';

            const darkColors = [
            '#8ec07c', '#fabd2f', '#83a598', '#d3869b', '#fe8019',
            '#b8bb26', '#fb4934', '#928374', '#458588', '#cc241d'
            ];

            window.statsPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(dataSource),
                datasets: [{
                data: Object.values(dataSource),
                backgroundColor: darkColors,
                borderColor: '#222',
                borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    labels: {
                    color: '#cfcfcf',
                    font: { family: 'JetBrains Mono', size: 14 },
                    padding: 16
                    },
                    position: 'bottom'
                },
                tooltip: {
                    backgroundColor: '#1f1f1f',
                    titleColor: '#ffffff',
                    bodyColor: '#dddddd',
                    titleFont: { family: 'JetBrains Mono', size: 14 },
                    bodyFont: { family: 'JetBrains Mono', size: 12 }
                }
                }
            }
            });
        }

        // Initial load
        fetchStats();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = '/';
        });
        // Delete dialog handlers
        const deleteDialog = document.getElementById('delete-dialog');
        const deleteConfirm = document.getElementById('delete-confirm');
        const deleteCancel = document.getElementById('delete-cancel');
        let pendingDelete = null;

        deleteConfirm.addEventListener('click', async () => {
            if (pendingDelete) {
                const { index, url, currentImages, updateImagesContainer } = pendingDelete;
                try {
                    await deleteImage(url);
                    currentImages.splice(index, 1);
                    updateImagesContainer(currentImages);
                } catch (error) {
                    // error already alerted
                }
                pendingDelete = null;
            }
            deleteDialog.classList.replace('flex', 'hidden');
        });

        deleteCancel.addEventListener('click', () => {
            pendingDelete = null;
            deleteDialog.classList.replace('flex', 'hidden');
        });

        // On page load
        fetchPendingRices();
    </script>
</body>
</html> 